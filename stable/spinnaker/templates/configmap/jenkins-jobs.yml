apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-jenkins-jobs
data:
  run-script.xml: |-
    <?xml version='1.0' encoding='UTF-8'?>
    <project>
      <actions/>
      <description></description>
      <logRotator class="hudson.tasks.LogRotator">
        <daysToKeep>10</daysToKeep>
        <numToKeep>500</numToKeep>
        <artifactDaysToKeep>-1</artifactDaysToKeep>
        <artifactNumToKeep>-1</artifactNumToKeep>
      </logRotator>
      <keepDependencies>false</keepDependencies>
      <properties>
        <hudson.model.ParametersDefinitionProperty>
          <parameterDefinitions>
            <hudson.model.StringParameterDefinition>
              <name>TASK_ID</name>
              <description>Unique Task Id generated by Spinnaker</description>
              <defaultValue>0</defaultValue>
            </hudson.model.StringParameterDefinition>
            <hudson.model.StringParameterDefinition>
              <name>SCRIPT_PATH</name>
              <description>Path to the folder hosting the scripts</description>
              <defaultValue>.</defaultValue>
            </hudson.model.StringParameterDefinition>
            <hudson.model.StringParameterDefinition>
              <name>COMMAND</name>
              <description>Executable script and parameters</description>
              <defaultValue></defaultValue>
            </hudson.model.StringParameterDefinition>
            <hudson.model.StringParameterDefinition>
              <name>IMAGE_ID</name>
              <description>The image ID for this region based on the AMI Spinnaker is deploying</description>
              <defaultValue></defaultValue>
            </hudson.model.StringParameterDefinition>
            <hudson.model.StringParameterDefinition>
              <name>REGION_PARAM</name>
              <description>The region the Spinnaker deployment is running against</description>
              <defaultValue></defaultValue>
            </hudson.model.StringParameterDefinition>
            <hudson.model.StringParameterDefinition>
              <name>ENV_PARAM</name>
              <description>Environment Spinnaker is running against</description>
              <defaultValue></defaultValue>
            </hudson.model.StringParameterDefinition>
            <hudson.model.StringParameterDefinition>
              <name>CLUSTER_PARAM</name>
              <description>The cluster Spinnaker is deploying to</description>
              <defaultValue></defaultValue>
            </hudson.model.StringParameterDefinition>
            <hudson.model.StringParameterDefinition>
              <name>CMC</name>
              <description>The CMC this deployment is associated with</description>
              <defaultValue></defaultValue>
            </hudson.model.StringParameterDefinition>
            <hudson.model.StringParameterDefinition>
              <name>CONTEXT</name>
              <description>The parameters available to this task</description>
              <defaultValue></defaultValue>
            </hudson.model.StringParameterDefinition>
            <hudson.model.StringParameterDefinition>
              <name>REPO_URL</name>
              <description>git repository url.</description>
              <defaultValue></defaultValue>
            </hudson.model.StringParameterDefinition>
          </parameterDefinitions>
        </hudson.model.ParametersDefinitionProperty>
      </properties>
      <scm class="hudson.plugins.git.GitSCM" plugin="git@2.4.0">
        <configVersion>2</configVersion>
        <userRemoteConfigs>
          <hudson.plugins.git.UserRemoteConfig>
            <name>apidaemon</name>
            <url>$REPO_URL</url>
          </hudson.plugins.git.UserRemoteConfig>
        </userRemoteConfigs>
        <branches>
          <hudson.plugins.git.BranchSpec>
            <name>master</name>
          </hudson.plugins.git.BranchSpec>
        </branches>
        <doGenerateSubmoduleConfigurations>false</doGenerateSubmoduleConfigurations>
        <submoduleCfg class="list"/>
      </scm>
      <concurrentBuild>true</concurrentBuild>
      <builders>
        <hudson.plugins.descriptionsetter.DescriptionSetterBuilder plugin="description-setter@1.10">
          <description>TASK=${TASK_ID} REGION=${REGION_PARAM} ENV=${ENV_PARAM} CLUSTER=${CLUSTER_PARAM} IMAGE=${IMAGE_ID} CMC=${CMC} ${SCRIPT_PATH}/${COMMAND} ${CONTEXT}</description>
        </hudson.plugins.descriptionsetter.DescriptionSetterBuilder>
        <hudson.tasks.Shell>
          <command># To run groovy scripts in this stage, you need to add groovy to your path:
    # export PATH=$PATH:/PATH/TO/GROOVY/bin
    # To add support for grapes, you need to install the package and add this flag,
    # pointing to the correct grape root directory.
    # export JAVA_OPTS=&apos;-Dgrape.root=${WORKSPACE}/.groovy/grape&apos;
    echo ${TASK_ID}
    ${SCRIPT_PATH}/${COMMAND}</command>
        </hudson.tasks.Shell>
      </builders>
      <publishers>
        <hudson.tasks.ArtifactArchiver>
          <artifacts>*.properties, *.json, *.yml</artifacts>
          <allowEmptyArchive>true</allowEmptyArchive>
          <onlyIfSuccessful>false</onlyIfSuccessful>
          <fingerprint>false</fingerprint>
          <defaultExcludes>true</defaultExcludes>
        </hudson.tasks.ArtifactArchiver>
      </publishers>
      <buildWrappers/>
    </project>
  build-image.xml: |-
    <?xml version='1.0' encoding='UTF-8'?>
    <flow-definition plugin="workflow-job@2.9">
      <actions/>
      <description></description>
      <keepDependencies>false</keepDependencies>
      <properties>
        <hudson.model.ParametersDefinitionProperty>
          <parameterDefinitions>
            <hudson.model.StringParameterDefinition>
              <name>REPOSITORY_URL</name>
              <description></description>
              <defaultValue></defaultValue>
            </hudson.model.StringParameterDefinition>
            <hudson.model.StringParameterDefinition>
              <name>IMAGE_REPO</name>
              <description></description>
              <defaultValue></defaultValue>
            </hudson.model.StringParameterDefinition>
            <hudson.model.StringParameterDefinition>
              <name>IMAGE_TAG</name>
              <description></description>
              <defaultValue></defaultValue>
            </hudson.model.StringParameterDefinition>
          </parameterDefinitions>
        </hudson.model.ParametersDefinitionProperty>
        <org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
          <triggers/>
        </org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
      </properties>
      <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@2.23">
        <script>node {
        checkout([$class: &apos;GitSCM&apos;, 
              branches: [[name: &apos;*/master&apos;]], 
              doGenerateSubmoduleConfigurations: false, 
              extensions: [], 
              submoduleCfg: [], 
              userRemoteConfigs: [[url: &apos;$REPOSITORY_URL&apos;]]]
              )
    
        stage(&apos;save-env&apos;) {
            sh &apos;env &gt; properties&apos;
        }
        
        stage(&apos;build-image&apos;) {
            sh &apos;docker build -t $IMAGE_REPO:$IMAGE_TAG .&apos;
        }
        
        stage(&apos;push-image&apos;) {
            sh &apos;gcloud docker -- push $IMAGE_REPO:$IMAGE_TAG&apos;
        }
        archiveArtifacts &apos;properties&apos;
    }
    </script>
        <sandbox>true</sandbox>
      </definition>
      <triggers/>
    </flow-definition>
